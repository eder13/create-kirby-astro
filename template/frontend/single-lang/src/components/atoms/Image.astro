---
import type { Image } from '../../types/image'

interface Props extends Image {
    class?: string;
    lazyLoad: boolean;
    fetchpriority?: 'high' | 'low' | 'auto';
    style?: string | Record<string, string | number | null | undefined>;
    blurry: boolean;
    wrapped?: boolean;
    wrapperStyle?: string | Record<string, string | number | null | undefined>;
    isShowcase?: boolean;
}

const { alt, srcset, class: className, lazyLoad, fetchpriority, url, style, width, height, blurry, id, thumbnail, wrapped, wrapperStyle, isShowcase, ...rest } = Astro.props;
const sizes = "(max-width: 768px) 280px, (min-width: 768px) and (max-width: 992px) 371px, (min-width: 992px) and (max-width: 1200px) 500px, (min-width: 1200px) and (max-width: 1560px) 720px, (min-width: 1560px) and (max-width: 1920px) 1000px, (min-width: 1920px) and (max-width: 2560px) 1500px, (min-width: 2560px) 2000px"

---
{(blurry || wrapped) ? 
    <div style={wrapperStyle} class:list={['wrapper', blurry && "wrapper-img-blurry", wrapped && "wrapper-img", isShowcase && 'showcase-image-style']}>
        <img
            {...(blurry ? 
            { src: thumbnail } : 
            {
                src: url,
                srcset: srcset,
                sizes: sizes
            })}
            width={width}
            height={height}
            id={id}
            alt={alt}
            class:list={[className && className, 'img', blurry && 'blurry']}
            decoding="auto"
            loading={lazyLoad ? 'lazy' : 'eager'}
            fetchpriority={fetchpriority ? fetchpriority : 'auto'}
            style={style}
            { ...rest }
        />
    </div> :     
     !url.includes('undefined') ? <img
        src={url}
        srcset={srcset}
        sizes={sizes}
        width={width}
        height={height}
        id={id}
        alt={alt}
        class:list={[className && className, 'img', blurry && 'blurry']}
        decoding="auto"
        loading={lazyLoad ? 'lazy' : 'eager'}
        fetchpriority={fetchpriority ? fetchpriority : 'auto'}
        style={style}
        { ...rest }
    /> : <></> }

<style>
    .wrapper {
        display: flex;
        align-items: center;
    }

    .showcase-image-style {
        aspect-ratio: 9 / 16;
        position: relative;
        transform: translateX(-100svw);
        animation: slidein 1.1s ease-out 0.4s forwards;
    }

    @keyframes slidein {
        from {
            transform: translateX(-100svw);
        }

        to {
            transform: translateX(0%);
        }
    }

    .wrapper-img {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .wrapper-img-blurry {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .wrapper-img-blurry::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        backdrop-filter: var(--backdrop-filter);
        transition: backdrop-filter .2s ease-in;
    }

    .img {
        height: auto;
        width: 100%;
        position: relative;
    }
</style>

{blurry &&
    <script is:inline is:raw type="text/javascript" define:vars={{ id, url, srcset, sizes }}>
        function onImageLoaded(newImageElement) {            
            const currentImage = document.getElementById(id);
            currentImage.src = newImageElement.src;
            currentImage.srcset = newImageElement.srcset;
            currentImage.sizes = newImageElement.sizes;
            currentImage.parentElement.style.setProperty('--backdrop-filter', 'blur(0)');
        }
        
        const image = new Image();
        image.srcset = srcset;
        image.src = url;
        image.sizes = sizes;

        if (image.complete) {
            onImageLoaded(image);
        } else {
            image.addEventListener('load', () => onImageLoaded(image), { once: true });
        }
    </script>
}
